/******************************************************************************
 * @license
 * Copyright (C) 2008-2014, Roman Lygin. All rights reserved.
 * Copyright (C) 2014-2022, CADEX. All rights reserved.
 *
 * This file is part of the CAD Exchanger software.
 *
 * This file may be used under the terms and conditions of the License
 * Agreement supplied with the software.
 *
 * This file is provided "AS IS" WITH NO WARRANTY OF ANY KIND, EITHER EXPRESSED
 * OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE WARRANTY OF DESIGN,
 * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 *
 *****************************************************************************/
(function(g,f){"object"===typeof exports&&"undefined"!==typeof module?f(exports,require("@cadexchanger/web-toolkit"),require("three")):"function"===typeof define&&define.amd?define(["exports","@cadexchanger/web-toolkit","three"],f):(g=g||self,f(g.cadex=g.cadex||{},cadex,THREE));}(this,function(exports,cadex,THREE){
var f="function"==typeof Object.create?Object.create:function(a){function b(){}b.prototype=a;return new b};function l(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");}var m=l(this),p;
if("function"==typeof Object.setPrototypeOf)p=Object.setPrototypeOf;else{var r;a:{var t={a:!0},u={};try{u.__proto__=t;r=u.a;break a}catch(a){}r=!1}p=r?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null}var v=p;
function w(a,b){a.prototype=f(b.prototype);a.prototype.constructor=a;if(v)v(a,b);else for(var c in b)if("prototype"!=c)if(Object.defineProperties){var g=Object.getOwnPropertyDescriptor(b,c);g&&Object.defineProperty(a,c,g)}else a[c]=b[c];a.u=b.prototype}function x(a,b){b.setRGB(a.r,a.g,a.b)}function y(a,b){x(a,b.color);b.opacity=a.a;1>a.a&&(b.transparent=!0)}function z(a){var b=cadex.ModelData_RepresentationVisitor.call(this)||this;b.h=void 0;b.i=a;return b}w(z,cadex.ModelData_RepresentationVisitor);
z.prototype.visitBRepRepresentation=function(a){var b=this;return a.bodyList().then(function(c){0<c.size()&&(b.h=new THREE.Group,a.name&&(b.h.name=a.name));for(var g=0,k=c.size();g<k;g++){var h=c.element(g).prs;h&&(h=h.faces||h.edges||h.vertexes)&&(h=b.i(h))&&b.h.add(h)}})};z.prototype.visitPolyRepresentation=function(a){var b=this;return a.polyShapeList().then(function(c){0<c.size()&&(b.h=new THREE.Group,a.name&&(b.h.name=a.name));for(var g=0,k=c.size();g<k;g++){var h=c.element(g);(h=b.i(h))&&b.h.add(h)}})};
z.prototype.visitPolyRepresentation=z.prototype.visitPolyRepresentation;z.prototype.visitBRepRepresentation=z.prototype.visitBRepRepresentation;function A(a,b){var c=cadex.ModelData_SceneGraphElementVisitor.call(this)||this;c.i=[a];c.h=[b.defaultAppearance||new cadex.ModelData_Appearance];c.s=new Map;c.o=b;return c}w(A,cadex.ModelData_SceneGraphElementVisitor);
A.prototype.visitPart=function(a){var b=this,c=this.h[this.h.length-1];a.appearance&&(c=c.clone().combineWith(a.appearance));a=a.representation(this.o.representationSelector);if(!a)return Promise.resolve();var g=new z(function(k){return E(k,c)});return a.accept(g).then(function(){g.h&&b.i[b.i.length-1].add(g.h)})};
A.prototype.visitInstanceEnter=function(a){var b=new THREE.Object3D,c=(new THREE.Matrix4).fromArray(a.transformation.elements);b.applyMatrix(c);this.i[this.i.length-1].add(b);this.i.push(b);(a=a.appearance)&&this.h.push(this.h[this.h.length-1].clone().combineWith(a));return!0};A.prototype.visitInstanceLeave=function(a){this.i.pop();a.appearance&&this.h.pop()};A.prototype.visitAssemblyEnter=function(){return!0};A.prototype.visitAssemblyLeave=function(){};A.prototype.visitAssemblyLeave=A.prototype.visitAssemblyLeave;
A.prototype.visitAssemblyEnter=A.prototype.visitAssemblyEnter;A.prototype.visitInstanceLeave=A.prototype.visitInstanceLeave;A.prototype.visitInstanceEnter=A.prototype.visitInstanceEnter;A.prototype.visitPart=A.prototype.visitPart;
function F(a){if(!a||!a.coords||!a.coords.length)return null;var b=new THREE.BufferGeometry;b.addAttribute("position",new THREE.BufferAttribute(a.coords,3));a.colors&&b.addAttribute("color",new THREE.BufferAttribute(a.colors,3));a instanceof cadex.ModelData_IndexedTriangleSet&&(a.indexes&&b.setIndex(new THREE.BufferAttribute(a.indexes,1)),a.normals?b.addAttribute("normal",new THREE.BufferAttribute(a.normals,3)):b.computeVertexNormals(),a.uvCoordinates&&b.addAttribute("uv",new THREE.BufferAttribute(a.uvCoordinates,
2)));a instanceof cadex.ModelData_IndexedPolyLineSet&&a.indexes&&b.setIndex(new THREE.BufferAttribute(a.indexes,1));return b}
function E(a,b){function c(d){if(h&&0<h.length){var e=!1,B=q.length;h.forEach(function(n){var C=n.appearanceIndex;0<=C&&C<B?k.addGroup(n.start,n.count,n.appearanceIndex):(e=!0,k.addGroup(n.start,n.count,B))});e&&q.push(b);var D=q.map(function(n){return d(n)})}else D=d(q[0]||b);return D}function g(d){return d?b.copyAndCombineWith(d):b}var k=F(a);if(!k)return null;if(a instanceof cadex.ModelData_MultiAppearanceIndexedTriangleSet||a instanceof cadex.ModelData_MultiAppearanceIndexedPolyLineSet||a instanceof
cadex.ModelData_MultiAppearancePolyPointSet){var h=a.groups;var q=a.appearances.map(g)}else q=[g(a.appearance)];return a instanceof cadex.ModelData_IndexedTriangleSet?(a=c(function(d){var e=new THREE.MeshPhongMaterial;e.side=THREE.DoubleSide;d&&(d.material?(d=d.material,y(d.diffuseColor,e),x(d.specularColor,e.specular),e.specular.r/=10,e.specular.g/=10,e.specular.b/=10,x(d.emissiveColor,e.emissive),e.shininess=d.shininess):d.genericColor&&y(d.genericColor,e));return e}),new THREE.Mesh(k,a)):a instanceof
cadex.ModelData_PolyLineSet?(a=c(function(){var d=new THREE.LineBasicMaterial;b&&(b.material&&b.material.diffuseColor?y(b.material.diffuseColor,d):b.genericColor&&y(b.genericColor,d));return d}),new THREE.LineSegments(k,a)):a instanceof cadex.ModelData_PolyPointSet?(a=c(function(){var d=new THREE.PointsMaterial;var e=b&&(b.material&&b.material.diffuseColor||b.genericColor);e&&y(e,d);return d}),new THREE.Points(k,a)):null}
function G(a,b){var c=new THREE.Group;b=new A(c,b);return a.accept(b).then(function(){return 1<c.children.length?c:1===c.children.length?c.children[0]:null})}function H(a,b){var c=new THREE.Group;b=new A(c,b);return a.accept(b).then(function(){return c})}function I(){this.i=new cadex.ModelData_RepresentationMaskSelector(cadex.ModelData_RepresentationMask.ModelData_RM_Any);this.h=new cadex.ModelData_Appearance(new cadex.ModelData_ColorObject(.5,.5,.5))}
m.Object.defineProperties(I.prototype,{representationSelector:{configurable:!0,enumerable:!0,get:function(){return this.i},set:function(a){a instanceof cadex.ModelData_RepresentationSelector&&(this.i=a)}},defaultAppearance:{configurable:!0,enumerable:!0,get:function(){return this.h},set:function(a){a instanceof cadex.ModelData_Appearance&&(this.h=a)}}});function J(a){this.h=a instanceof I?a:new I}
J.prototype.j=function(a){return a instanceof cadex.ModelData_Model?THREE&&THREE.Object3D?H(a,this.h):Promise.reject(Error("THREE namespace is not defined. Please link three.js library (https://threejs.org) before converter usage.")):Promise.reject(Error("TypeError: invalid argument (it should be instance of cadex.ModelData_Model)"))};
J.prototype.m=function(a){return a instanceof cadex.ModelData_SceneGraphElement?THREE&&THREE.Object3D?G(a,this.h):Promise.reject(Error("THREE namespace is not defined. Please link three.js library (https://threejs.org) before converter usage.")):Promise.reject(Error("TypeError: invalid argument (it should be instance of cadex.ModelData_SceneGraphElement)"))};
J.prototype.l=function(a){if(!(a instanceof cadex.ModelData_PolyVertexSet))throw Error("TypeError: invalid argument (it should be instance of cadex.ModelData_PolyVertexSet)");if(!THREE||!THREE.Object3D)throw Error("THREE namespace is not defined. Please link three.js library (https://threejs.org) before converter usage.");return E(a,this.h.defaultAppearance||new cadex.ModelData_Appearance)};m.Object.defineProperties(J.prototype,{parameters:{configurable:!0,enumerable:!0,get:function(){return this.h}}});
J.prototype.convertPolyVertexSet=J.prototype.l;J.prototype.convertSceneGraphElement=J.prototype.m;J.prototype.convertModel=J.prototype.j;Object.assign(exports,{ModelAlgo_ThreejsConverter:J,ModelAlgo_ThreejsConverterParameters:I});
}));
